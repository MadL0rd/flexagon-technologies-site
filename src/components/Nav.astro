---
import logoUrl from '@assets/logo.svg?url';
import menuIconUrl from '@assets/apps-rectangle.svg?url';

const isHome = Astro.url.pathname === '/';
const link = (anchor: string) => (isHome ? anchor : `/${anchor}`);
---
<nav>
  <div class="navbar">
    <div class="nav-main">
      <a class="nav-brand" href="/" aria-label="Flexagon Technologies — на главную">
        <span class="nav-logo">
          <img src={logoUrl} alt="Flexagon Technologies" width="140" height="48" loading="lazy" />
        </span>
        <span class="nav-title" role="heading" aria-level="1">Flexagon Technologies</span>
      </a>
      <button class="nav-toggle" type="button" aria-label="Открыть меню" aria-controls="nav-menu" aria-expanded="false">
        <img src={menuIconUrl} alt="" aria-hidden="true" width="28" height="28" loading="lazy" />
      </button>
    </div>
    <div class="nav-links" id="nav-menu">
      <a href={link('#services')}>Услуги</a>
      <a href={link('#tech')}>Технологии</a>
      <a href={link('#process')}>Процесс</a>
      <a href="/blog">Блог</a>
      <a href={link('#contact')}>Контакты</a>
    </div>
  </div>
</nav>
<script type="module">
  document.addEventListener('astro:load', () => {
    document.querySelectorAll('.navbar').forEach((navbar) => {
      const toggle = navbar.querySelector('.nav-toggle');
      const navLinks = navbar.querySelector('.nav-links');
      const navElement = navbar.closest('nav');

      if (!(toggle instanceof HTMLButtonElement) || !(navLinks instanceof HTMLElement)) {
        return;
      }

      const setMenuState = (isOpen: boolean) => {
        toggle.setAttribute('aria-expanded', String(isOpen));
        toggle.setAttribute('aria-label', isOpen ? 'Закрыть меню' : 'Открыть меню');
        navbar.classList.toggle('is-open', isOpen);
        navElement?.classList.toggle('is-open', isOpen);
        navLinks.classList.toggle('is-open', isOpen);
        document.body.classList.toggle('nav-is-open', isOpen);
      };

      navbar.classList.add('has-collapsible-nav');

      const closeMenu = (focusToggle = false) => {
        setMenuState(false);

        if (focusToggle) {
          toggle.focus();
        }
      };

      setMenuState(false);

      toggle.addEventListener('click', () => {
        const expanded = toggle.getAttribute('aria-expanded') === 'true';
        const nextExpanded = !expanded;

        setMenuState(nextExpanded);
      });

      navLinks.querySelectorAll('a').forEach((link) => {
        link.addEventListener('click', closeMenu);
      });

      navbar.addEventListener('click', (event) => {
        if (!navbar.classList.contains('is-open')) {
          return;
        }

        const target = event.target;

        if (!(target instanceof Node)) {
          return;
        }

        if (navLinks.contains(target)) {
          return;
        }

        const navMain = navbar.querySelector('.nav-main');

        if (navMain instanceof HTMLElement && navMain.contains(target)) {
          return;
        }

        closeMenu();
      });

      const handleKeydown = (event: KeyboardEvent) => {
        if (event.key === 'Escape') {
          closeMenu(true);
        }
      };

      document.addEventListener('keydown', handleKeydown);

      const desktopMediaQuery = window.matchMedia('(min-width: 769px)');
      const handleViewportChange = (event: MediaQueryListEvent) => {
        if (event.matches) {
          closeMenu();
        }
      };

      desktopMediaQuery.addEventListener('change', handleViewportChange);

      const cleanup = () => {
        document.removeEventListener('keydown', handleKeydown);
        desktopMediaQuery.removeEventListener('change', handleViewportChange);
      };

      window.addEventListener('beforeunload', cleanup, { once: true });
    });
  });
</script>
